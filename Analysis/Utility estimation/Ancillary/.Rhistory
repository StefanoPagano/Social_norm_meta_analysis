#  merge.data.frame(observation, by = "treatment_id") %>%
#  mutate(weight_SE=n^2)
# Uncomment this if want to use obs. weights
#avg_se <- df_se %>%
#  summarise(across(se_basegammaNU:se_sucaNU, ~weighted.mean(.^2, w = weight_SE, na.rm=T)))
#df_se <- df_se %>%
#  add_row(treatment_id="Average", sqrt(avg_se), n=sum(df_se$n), weight_SE=sum(df_se$weight_SE))
# XXX CHECK ANDREA #################
# avg coefficient with inverse variance
## remove treatments with issues
##treatment_removed = c("2023Eck169_1a")
##df_coeff[c(which(df_coeff$treatment_id=="2023Eck169_1a")), c("nuNU", "etaNU", "gammaNU", "rhoNU", "sigmaNU")] = NA
##df_se[c(which(df_se$treatment_id=="2023Eck169_1a")), c("se_nuNU", "se_etaNU", "se_gammaNU", "se_rhoNU", "se_sigmaNU")] = NA
p = 11 + 1 # number of parameters plus 1
df_se[, 2:p][df_se[, 2:p]==0] <- NA
num <- colSums(df_coeff[,2:p]/df_se[,2:p]^2, na.rm = T)
den <- colSums(1/df_se[,2:p]^2, na.rm = T)
ration <- data.frame(t(num/den))
df_coeff <- df_coeff %>%
add_row(treatment_id="Average", ration, n=sum(df_coeff$n), Game_type="DG")
# compute variance of coefficient (1/den)
se_average <- data.frame(t(sqrt(1/den)))
colnames(se_average) <- colnames(df_se)[2:p]
df_se <- df_se %>%
add_row(treatment_id="Average", se_average)#, n=sum(df_se$n) Uncomment if using obs as weights, weight_SE=sum(df_se$weight_SE))
##################
# produce 95% CI of averages
df_models <- merge.data.frame(df_coeff, df_se, by = "treatment_id")
average_ci_u <- df_coeff[t+1,2:p] + 1.96*df_se[t+1,2:p]
average_ci_l <- df_coeff[t+1,2:p] - 1.96*df_se[t+1,2:p]
rbind.data.frame(average_ci_l, df_coeff[t+1,2:p], average_ci_u)
write.csv(df_models, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertainty_MODEL_DG.csv", row.names = F)
0.01833170-0.03511281
-0.03511281-0.01833170
0.07177620-0.01833170
## STATA LOG FILE READING
setwd("C:/Users/a.guido/Documents/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Ancillary")
t=14 # modify this based on the number of treatments to consider
library(tidyverse)
# 1. QUESTO SCRIPT LEGGE IL FILE LOG AIC DA STATA ---------------
## MODIFICARE SUFFISSO "_DG" CON "_ToG" O "_DON"
## MODIFICARE n_max = x, x ? UGUALE AL NUMERO DI TRATTAMENTI
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/stata_AIC_ONG.log"
df_aic <- read_log(file=log_file,
skip=10,
n_max = t)
colnames(df_aic) <- c("treatment_id", "Selfish_aic", "Norm_aic", "DA_aic", "FU_aic")
avg_aic <- df_aic %>%
summarise(across(Selfish_aic:FU_aic, ~mean(., na.rm=T)))
df_aic <- df_aic %>%
add_row(treatment_id="Average", avg_aic)
write.csv(df_aic, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/AIC_DG.csv", row.names = F)
# 2. QUESTO SCRIPT LEGGE IL FILE LOG COEFF DA STATA -------------
## MODIFICARE n_max = x, x ? UGUALE AL NUMERO DI TRATTAMENTI
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/stata_COEFF_ONG.log"
df_coeff <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
colnames(df_coeff) <- c("treatment_id", "deltaS", "deltaN", "gammaN", "rhoDA", "sigmaDA", "rhoFU", "sigmaFU", "gammaFU")
observation <- read.csv("../Data/new_data_utility2025-07-23.csv") %>% distinct(treatment_id,subject_id,Game_type) %>% group_by(treatment_id,Game_type) %>% tally()
cols_to_check <- c("sigmaDA", "rhoFU", "sigmaFU")
df_coeff <- df_coeff %>% mutate(across(all_of(cols_to_check), ~ ifelse(. == 0, NA, .))) %>%
merge.data.frame(observation, by = "treatment_id")
# Uncomment this if want to use obs. weights
#avg_coeff <- df_coeff %>%
#  summarise(across(deltaS:gammaFU, ~weighted.mean(., w = n, na.rm=T)))
#df_coeff <- df_coeff %>%
#  add_row(treatment_id="Average", avg_coeff, n=sum(df_coeff$n), Game_type="DG")
#QUESTO SCRIPT LEGGE IL FILE LOG STD ERR DA STATA ------
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/stata_SE_ONG.log"
df_se <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
colnames(df_se) <- c("treatment_id", "se_deltaS", "se_deltaN", "se_gammaN", "se_rhoDA", "se_sigmaDA", "se_rhoFU", "se_sigmaFU", "se_gammaFU")
# Uncomment this if want to use obs. weights
#df_se <- df_se %>%
#  merge.data.frame(observation, by = "treatment_id") %>%
#  mutate(weight_SE=n^2)
#avg_se <- df_se %>%
#  summarise(across(se_deltaS:se_gammaFU, ~weighted.mean(.^2, w = weight_SE, na.rm=T)))
#df_se <- df_se %>%
#  add_row(treatment_id="Average", sqrt(avg_se), n=sum(df_se$n), weight_SE=sum(df_se$weight_SE))
# XXX CHECK ANDREA #################
# avg coefficient with inverse variance
df_se[, 2:9][df_se[, 2:9]==0] <- NA
num <- colSums(df_coeff[,2:9]*(1/df_se[,2:9]^2), na.rm=T)
den <- colSums(1/df_se[,2:9]^2, na.rm=T)
ration <- data.frame(t(num/den))
df_coeff <- df_coeff %>%
add_row(treatment_id="Average", ration, n=sum(df_coeff$n), Game_type="DG")
# compute variance of coefficient (1/den)
se_average <- data.frame(t(sqrt(1/den)))
colnames(se_average) <- colnames(df_se)[2:9]
df_se <- df_se %>%
add_row(treatment_id="Average", se_average)#, n=sum(df_se$n) Uncomment when using obs as weights, weight_SE=sum(df_se$weight_SE))
##################
# produce 95% CI of averages
df_models <- merge.data.frame(df_coeff, df_se, by = "treatment_id")
average_ci_u <- df_coeff[t+1,2:9] + 1.96*df_se[t+1,2:9]
average_ci_l <- df_coeff[t+1,2:9] - 1.96*df_se[t+1,2:9]
rbind.data.frame(average_ci_l, df_coeff[t+1,2:9], average_ci_u)
write.csv(round(rbind.data.frame(average_ci_l, df_coeff[t+1,2:9], average_ci_u), 3), "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/95CI_MODEL_DG.csv", row.names = F)
write.csv(df_models, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/MODEL_DG.csv", row.names = F)
# 3. MODELLI CON NORM UNCERTAINTY ----------------
#QUESTO SCRIPT LEGGE IL FILE LOG COEFF DA STATA
## MODIFICARE n_max = x, x ? UGUALE AL NUMERO DI TRATTAMENTI
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertain_stata_COEFF_NU.log"
df_coeff <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
#colnames(df_coeff) <- c("treatment_id", "basegammaNU", "baseetaNU", "gammaNU", "etaNU", "nuNU", "baserhoNU", "basesigmaNU", "rhoNU", "sigmaNU")
colnames(df_coeff) <- c("treatment_id", "basedeltaNU", "basegammaNU", "baseetaNU", "deltaNU", "gammaNU", "etaNU", "nuNU", "baserhoNU", "basesigmaNU", "rhoNU", "sigmaNU")
observation <- read.csv("../Data/new_data_utility2025-07-23.csv") %>% distinct(treatment_id,subject_id,Game_type) %>% group_by(treatment_id,Game_type) %>% tally()
df_coeff <- df_coeff %>%
merge.data.frame(observation, by = "treatment_id")
# Uncomment this if want to use obs. weights
#avg_coeff <- df_coeff %>%
#  summarise(across(basegammaNU:sucaNU, ~weighted.mean(., w = n, na.rm=T)))
#df_coeff <- df_coeff %>%
#  add_row(treatment_id="Average", avg_coeff, n=sum(df_coeff$n), Game_type="DG")
#QUESTO SCRIPT LEGGE IL FILE LOG STD ERR DA STATA
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertain_stata_SE_NU.log"
df_se <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
#colnames(df_se) <- c("treatment_id", "se_basegammaNU", "se_baseetaNU", "se_gammaNU", "se_etaNU", "se_nuNU", )
colnames(df_se) <- c("treatment_id", "se_basedeltaNU", "se_basegammaNU", "se_baseetaNU", "se_deltaNU", "se_gammaNU", "se_etaNU", "se_nuNU", "se_baserhoNU", "se_basesigmaNU", "se_rhoNU", "se_sigmaNU")
#df_se <- df_se %>%
#  merge.data.frame(observation, by = "treatment_id") %>%
#  mutate(weight_SE=n^2)
# Uncomment this if want to use obs. weights
#avg_se <- df_se %>%
#  summarise(across(se_basegammaNU:se_sucaNU, ~weighted.mean(.^2, w = weight_SE, na.rm=T)))
#df_se <- df_se %>%
#  add_row(treatment_id="Average", sqrt(avg_se), n=sum(df_se$n), weight_SE=sum(df_se$weight_SE))
# XXX CHECK ANDREA #################
# avg coefficient with inverse variance
## remove treatments with issues
##treatment_removed = c("2023Eck169_1a")
##df_coeff[c(which(df_coeff$treatment_id=="2023Eck169_1a")), c("nuNU", "etaNU", "gammaNU", "rhoNU", "sigmaNU")] = NA
##df_se[c(which(df_se$treatment_id=="2023Eck169_1a")), c("se_nuNU", "se_etaNU", "se_gammaNU", "se_rhoNU", "se_sigmaNU")] = NA
p = 11 + 1 # number of parameters plus 1
df_se[, 2:p][df_se[, 2:p]==0] <- NA
num <- colSums(df_coeff[,2:p]/df_se[,2:p]^2, na.rm = T)
den <- colSums(1/df_se[,2:p]^2, na.rm = T)
ration <- data.frame(t(num/den))
df_coeff <- df_coeff %>%
add_row(treatment_id="Average", ration, n=sum(df_coeff$n), Game_type="DG")
# compute variance of coefficient (1/den)
se_average <- data.frame(t(sqrt(1/den)))
colnames(se_average) <- colnames(df_se)[2:p]
df_se <- df_se %>%
add_row(treatment_id="Average", se_average)#, n=sum(df_se$n) Uncomment if using obs as weights, weight_SE=sum(df_se$weight_SE))
##################
# produce 95% CI of averages
df_models <- merge.data.frame(df_coeff, df_se, by = "treatment_id")
average_ci_u <- df_coeff[t+1,2:p] + 1.96*df_se[t+1,2:p]
average_ci_l <- df_coeff[t+1,2:p] - 1.96*df_se[t+1,2:p]
rbind.data.frame(average_ci_l, df_coeff[t+1,2:p], average_ci_u)
write.csv(df_models, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertainty_MODEL_DG.csv", row.names = F)
rm(list=ls())
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(ggbreak)
library(patchwork)
setwd("~/GitHub/Social_norm_meta_analysis/Analysis/")
## Define functions to plot ------------
model_df_generator <- function(file, uncertainty_model) {
df <- read.csv(file)
#
#  df <- df %>%
#    mutate(weight_SE=(n.x)^2)
#  if (uncertainty_model==0) {
#
#    average_coeff_stata <- df %>% summarise(across(deltaS:gammaFU, ~weighted.mean(., w = n.x, na.rm=T)))
#    average_SE_stata <- df %>% summarise(across(se_deltaS:se_gammaFU, ~weighted.mean(.^2, w = weight_SE, na.rm=T)))
#
#  } else {
#    average_coeff_stata <- df %>% summarise(across(basegammaNU:nuNU, ~weighted.mean(., w = n.x, na.rm=T)))
#    average_SE_stata <- df %>% summarise(across(se_basegammaNU:se_nuNU, ~weighted.mean(.^2, w = weight_SE, na.rm=T)))
#
#  }
#  df <- df %>%
#    add_row(treatment_id="Average", average_coeff_stata , sqrt(average_SE_stata), n.x=sum(df$n.x), weight_SE=sum(df$weight_SE))
#
invisible(df)
}
plot_coeff_social_generator <- function(data) {
s=0.2
# selfish model
plot_s_delta <- ggplot(data, aes(x=deltaS,y=treatment_id)) +
geom_pointrange(aes(xmin=deltaS-1.96*se_deltaS,xmax=deltaS+1.96*se_deltaS), shape=20, size = s) +
ylab("Treatment ID") +
xlab("S model - Coefficient of payoff (delta)") +
theme_light() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
# Social norm model (SN)
plot_sn_delta <- ggplot(data, aes(x=deltaN,y=treatment_id)) +
geom_pointrange(aes(xmin=deltaN-1.96*se_deltaN,xmax=deltaN+1.96*se_deltaN), shape=20, size=s) +
ylab("Treatment ID") +
xlab(expression(delta)) +
theme_light() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_sn_gamma <- ggplot(data, aes(x=gammaN,y=treatment_id)) +
geom_pointrange(aes(xmin=gammaN-1.96*se_gammaN,xmax=gammaN+1.96*se_gammaN), shape=20, size=s) +
xlab(expression(gamma)) +
theme_light() +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
# Social preferences models
plot_da_rho <- ggplot(data, aes(x=rhoDA,y=treatment_id)) +
geom_pointrange(aes(xmin=rhoDA-1.96*se_rhoDA,xmax=rhoDA+1.96*se_rhoDA), shape=20, size=s) +
ylab("Treatment ID") +
xlab(expression(rho)) +
theme_light() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_da_sigma <- ggplot(data, aes(x=sigmaDA,y=treatment_id)) +
geom_pointrange(aes(xmin=sigmaDA-1.96*se_sigmaDA,xmax=sigmaDA+1.96*se_sigmaDA), shape=20, size=s) +
xlab(expression(sigma)) +
theme_light() +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0) #xlim(c(-1,1))
# Full model (social preferences and social norms)
plot_fu_rho <- ggplot(data, aes(x=rhoFU,y=treatment_id)) +
geom_pointrange(aes(xmin=rhoFU-1.96*se_rhoFU,xmax=rhoFU+1.96*se_rhoFU), shape=20, size=s) +
ylab("Treatment ID") +
xlab(expression(rho)) +
theme_light() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_fu_sigma <- ggplot(data, aes(x=sigmaFU,y=treatment_id)) +
geom_pointrange(aes(xmin=sigmaFU-1.96*se_sigmaFU,xmax=sigmaFU+1.96*se_sigmaFU), shape=20, size=s) +
xlab(expression(sigma)) +
theme_light() +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_fu_gamma <- ggplot(data, aes(x=gammaFU,y=treatment_id)) +
geom_pointrange(aes(xmin=gammaFU-1.96*se_gammaFU,xmax=gammaFU+1.96*se_gammaFU), shape=20, size=s) +
xlab(expression(gamma)) +
theme_light() +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_da <- ggarrange(plot_da_rho, plot_da_sigma, common.legend=T, legend="bottom", widths = c(8,6))
plot_sn <- ggarrange(plot_sn_delta, plot_sn_gamma, common.legend=T, legend="bottom", widths = c(8,6))
plot_sn <- annotate_figure(plot_sn, top = text_grob("Social Norm model", face = "bold", size = 14))
plot_da <- annotate_figure(plot_da, top = text_grob("Social Preferences model", face = "bold", size = 14))
plot_fu <- ggarrange(plot_fu_rho, plot_fu_sigma, plot_fu_gamma, nrow = 1, common.legend=T, legend="bottom", widths = c(9,6,6))
plot_fu <- annotate_figure(plot_fu, top = text_grob("Extended model", face = "bold", size = 14))
#final_plot <- ggarrange(plot_sn, plot_da, plot_fu, ncol = 1)
return(list(plot_sn, plot_da, plot_fu))
}
plot_coeff_social_generator_uncertainty <- function(data){
s=0.2
# base model
plot_gamma <-  ggplot(data, aes(x=basegammaNU,y=treatment_id)) +
geom_pointrange(aes(xmin=basegammaNU-1.96*se_basegammaNU,xmax=basegammaNU+1.96*se_basegammaNU), shape=20, size=s) +
xlab(expression(gamma)) +
theme_light() +
ylab("Treatment ID") +
theme(#axis.text.y=element_blank(),
#axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_eta <-  ggplot(data, aes(x=baseetaNU,y=treatment_id)) +
geom_pointrange(aes(xmin=baseetaNU-1.96*se_baseetaNU,xmax=baseetaNU+1.96*se_baseetaNU), shape=20, size=s) +
xlab(expression(eta)) +
theme_light() +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
# model with interaction term
plot_gamma_i <-  ggplot(data, aes(x=gammaNU,y=treatment_id)) +
geom_pointrange(aes(xmin=gammaNU-1.96*se_gammaNU,xmax=gammaNU+1.96*se_gammaNU), shape=20, size=s) +
xlab(expression(gamma)) +
theme_light() +
ylab("Treatment ID") +
theme(#axis.text.y=element_blank(),
#axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_eta_i <-  ggplot(data, aes(x=etaNU,y=treatment_id)) +
geom_pointrange(aes(xmin=etaNU-1.96*se_etaNU,xmax=etaNU+1.96*se_etaNU), shape=20, size=s) +
xlab(expression(eta)) +
theme_light() +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_interaction <-  ggplot(data, aes(x=nuNU,y=treatment_id)) +
geom_pointrange(aes(xmin=nuNU-1.96*se_nuNU,xmax=nuNU+1.96*se_nuNU), shape=20, size=s) +
xlab(expression(nu)) +
theme_light() +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_sigma_i <- ggplot(data, aes(x=sigmaNU,y=treatment_id)) +
geom_pointrange(aes(xmin=sigmaNU-1.96*se_sigmaNU,xmax=sigmaNU+1.96*se_sigmaNU), shape=20, size=s) +
xlab(expression(sigma)) +
theme_light() +
ylab("Treatment ID") +
theme(axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_vline(xintercept = 0)
plot_rho_i <- ggplot(data, aes(x=rhoNU,y=treatment_id)) +
geom_pointrange(aes(xmin=rhoNU-1.96*se_rhoNU,xmax=rhoNU+1.96*se_rhoNU), shape=20, size=s) +
xlab(expression(rho)) +
theme_light() +
theme(#axis.text.y=element_blank(),
#axis.title.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())+
geom_vline(xintercept = 0)
plot_nu <- ggarrange(plot_gamma, plot_eta, common.legend=T, legend="bottom", widths = c(8,6))
plot_nu_i <- ggarrange(plot_gamma_i, plot_eta_i, plot_interaction, nrow=1, common.legend=T, legend="bottom", widths = c(8,6,6))
plot_nu_i_social <- ggarrange(plot_rho_i, plot_sigma_i, nrow=1, common.legend=T, legend="bottom", widths = c(8,6,6))
return(list(plot_nu, plot_nu_i, plot_nu_i_social))
}
## Plot coefficients -----------
stata_output_model <- read.csv("Utility estimation/Output/Logs/MODEL_DG.csv") #%>% mutate(
#  labels = case_when(
#
#  ))
#)
plots <- plot_coeff_social_generator(stata_output_model)
plot_sn <- plots[[1]]
plot_da <- plots[[2]]
plot_fu <- plots[[3]]
ggsave(filename = "Utility estimation/Output/Figures/model_social_norm.pdf", plot = plot_sn, width = 800, height = 400, units = "px", dpi = 120)
ggsave(filename = "Utility estimation/Output/Figures/model_social_preferences.pdf", plot=plot_da, width = 800, height = 400, units = "px", dpi = 120)
ggsave(filename = "Utility estimation/Output/Figures/model_full.pdf", plot=plot_fu, width = 800, height = 400, units = "px", dpi = 120)
stata_output_model_u <- read.csv("Utility estimation/Output/Logs/uncertainty_MODEL_DG.csv")
plots <- plot_coeff_social_generator_uncertainty(stata_output_model_u)
ggsave(filename = "Utility estimation/Output/Figures/unc_model_social_norm.pdf", plot = plots[[1]], width = 800, height = 400, units = "px", dpi = 120)
ggsave(filename = "Utility estimation/Output/Figures/unc_model_social_norm_interaction.pdf", plot=plots[[2]], width = 800, height = 400, units = "px", dpi = 120)
ggsave(filename = "Utility estimation/Output/Figures/unc_model_social_norm_interaction_social_pref.pdf", plot=plots[[3]], width = 800, height = 400, units = "px", dpi = 120)
## STATA LOG FILE READING
setwd("C:/Users/a.guido/Documents/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Ancillary")
t=14 # modify this based on the number of treatments to consider
library(tidyverse)
# 1. QUESTO SCRIPT LEGGE IL FILE LOG AIC DA STATA ---------------
## MODIFICARE SUFFISSO "_DG" CON "_ToG" O "_DON"
## MODIFICARE n_max = x, x ? UGUALE AL NUMERO DI TRATTAMENTI
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/stata_AIC_ONG.log"
df_aic <- read_log(file=log_file,
skip=10,
n_max = t)
colnames(df_aic) <- c("treatment_id", "Selfish_aic", "Norm_aic", "DA_aic", "FU_aic")
avg_aic <- df_aic %>%
summarise(across(Selfish_aic:FU_aic, ~mean(., na.rm=T)))
df_aic <- df_aic %>%
add_row(treatment_id="Average", avg_aic)
write.csv(df_aic, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/AIC_DG.csv", row.names = F)
# 2. QUESTO SCRIPT LEGGE IL FILE LOG COEFF DA STATA -------------
## MODIFICARE n_max = x, x ? UGUALE AL NUMERO DI TRATTAMENTI
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/stata_COEFF_ONG.log"
df_coeff <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
colnames(df_coeff) <- c("treatment_id", "deltaS", "deltaN", "gammaN", "rhoDA", "sigmaDA", "rhoFU", "sigmaFU", "gammaFU")
observation <- read.csv("../Data/new_data_utility2025-07-23.csv") %>% distinct(treatment_id,subject_id,Game_type) %>% group_by(treatment_id,Game_type) %>% tally()
cols_to_check <- c("sigmaDA", "rhoFU", "sigmaFU")
df_coeff <- df_coeff %>% mutate(across(all_of(cols_to_check), ~ ifelse(. == 0, NA, .))) %>%
merge.data.frame(observation, by = "treatment_id")
# Uncomment this if want to use obs. weights
#avg_coeff <- df_coeff %>%
#  summarise(across(deltaS:gammaFU, ~weighted.mean(., w = n, na.rm=T)))
#df_coeff <- df_coeff %>%
#  add_row(treatment_id="Average", avg_coeff, n=sum(df_coeff$n), Game_type="DG")
#QUESTO SCRIPT LEGGE IL FILE LOG STD ERR DA STATA ------
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/stata_SE_ONG.log"
df_se <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
colnames(df_se) <- c("treatment_id", "se_deltaS", "se_deltaN", "se_gammaN", "se_rhoDA", "se_sigmaDA", "se_rhoFU", "se_sigmaFU", "se_gammaFU")
# Uncomment this if want to use obs. weights
#df_se <- df_se %>%
#  merge.data.frame(observation, by = "treatment_id") %>%
#  mutate(weight_SE=n^2)
#avg_se <- df_se %>%
#  summarise(across(se_deltaS:se_gammaFU, ~weighted.mean(.^2, w = weight_SE, na.rm=T)))
#df_se <- df_se %>%
#  add_row(treatment_id="Average", sqrt(avg_se), n=sum(df_se$n), weight_SE=sum(df_se$weight_SE))
# XXX CHECK ANDREA #################
# avg coefficient with inverse variance
df_se[, 2:9][df_se[, 2:9]==0] <- NA
num <- colSums(df_coeff[,2:9]*(1/df_se[,2:9]^2), na.rm=T)
den <- colSums(1/df_se[,2:9]^2, na.rm=T)
ration <- data.frame(t(num/den))
df_coeff <- df_coeff %>%
add_row(treatment_id="Average", ration, n=sum(df_coeff$n), Game_type="DG")
# compute variance of coefficient (1/den)
se_average <- data.frame(t(sqrt(1/den)))
colnames(se_average) <- colnames(df_se)[2:9]
df_se <- df_se %>%
add_row(treatment_id="Average", se_average)#, n=sum(df_se$n) Uncomment when using obs as weights, weight_SE=sum(df_se$weight_SE))
##################
# produce 95% CI of averages
df_models <- merge.data.frame(df_coeff, df_se, by = "treatment_id")
average_ci_u <- df_coeff[t+1,2:9] + 1.96*df_se[t+1,2:9]
average_ci_l <- df_coeff[t+1,2:9] - 1.96*df_se[t+1,2:9]
rbind.data.frame(average_ci_l, df_coeff[t+1,2:9], average_ci_u)
write.csv(round(rbind.data.frame(average_ci_l, df_coeff[t+1,2:9], average_ci_u), 3), "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/95CI_MODEL_DG.csv", row.names = F)
write.csv(df_models, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/MODEL_DG.csv", row.names = F)
# 3. MODELLI CON NORM UNCERTAINTY ----------------
#QUESTO SCRIPT LEGGE IL FILE LOG COEFF DA STATA
## MODIFICARE n_max = x, x ? UGUALE AL NUMERO DI TRATTAMENTI
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertain_stata_COEFF_NU.log"
df_coeff <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
#colnames(df_coeff) <- c("treatment_id", "basegammaNU", "baseetaNU", "gammaNU", "etaNU", "nuNU", "baserhoNU", "basesigmaNU", "rhoNU", "sigmaNU")
colnames(df_coeff) <- c("treatment_id", "basedeltaNU", "basegammaNU", "baseetaNU", "deltaNU", "gammaNU", "etaNU", "nuNU", "baserhoNU", "basesigmaNU", "rhoNU", "sigmaNU")
observation <- read.csv("../Data/new_data_utility2025-07-23.csv") %>% distinct(treatment_id,subject_id,Game_type) %>% group_by(treatment_id,Game_type) %>% tally()
df_coeff <- df_coeff %>%
merge.data.frame(observation, by = "treatment_id")
# Uncomment this if want to use obs. weights
#avg_coeff <- df_coeff %>%
#  summarise(across(basegammaNU:sucaNU, ~weighted.mean(., w = n, na.rm=T)))
#df_coeff <- df_coeff %>%
#  add_row(treatment_id="Average", avg_coeff, n=sum(df_coeff$n), Game_type="DG")
#QUESTO SCRIPT LEGGE IL FILE LOG STD ERR DA STATA
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertain_stata_SE_NU.log"
df_se <- read_log(file=log_file,
skip=10,
n_max = t,
col_types=cols("c","n","n","n","n","n","n","n","n","n","n","n","n"))
#colnames(df_se) <- c("treatment_id", "se_basegammaNU", "se_baseetaNU", "se_gammaNU", "se_etaNU", "se_nuNU", )
colnames(df_se) <- c("treatment_id", "se_basedeltaNU", "se_basegammaNU", "se_baseetaNU", "se_deltaNU", "se_gammaNU", "se_etaNU", "se_nuNU", "se_baserhoNU", "se_basesigmaNU", "se_rhoNU", "se_sigmaNU")
#df_se <- df_se %>%
#  merge.data.frame(observation, by = "treatment_id") %>%
#  mutate(weight_SE=n^2)
# Uncomment this if want to use obs. weights
#avg_se <- df_se %>%
#  summarise(across(se_basegammaNU:se_sucaNU, ~weighted.mean(.^2, w = weight_SE, na.rm=T)))
#df_se <- df_se %>%
#  add_row(treatment_id="Average", sqrt(avg_se), n=sum(df_se$n), weight_SE=sum(df_se$weight_SE))
# XXX CHECK ANDREA #################
# avg coefficient with inverse variance
## remove treatments with issues
##treatment_removed = c("2023Eck169_1a")
##df_coeff[c(which(df_coeff$treatment_id=="2023Eck169_1a")), c("nuNU", "etaNU", "gammaNU", "rhoNU", "sigmaNU")] = NA
##df_se[c(which(df_se$treatment_id=="2023Eck169_1a")), c("se_nuNU", "se_etaNU", "se_gammaNU", "se_rhoNU", "se_sigmaNU")] = NA
p = 11 + 1 # number of parameters plus 1
df_se[, 2:p][df_se[, 2:p]==0] <- NA
num <- colSums(df_coeff[,2:p]/df_se[,2:p]^2, na.rm = T)
den <- colSums(1/df_se[,2:p]^2, na.rm = T)
ration <- data.frame(t(num/den))
df_coeff <- df_coeff %>%
add_row(treatment_id="Average", ration, n=sum(df_coeff$n), Game_type="DG")
# compute variance of coefficient (1/den)
se_average <- data.frame(t(sqrt(1/den)))
colnames(se_average) <- colnames(df_se)[2:p]
df_se <- df_se %>%
add_row(treatment_id="Average", se_average)#, n=sum(df_se$n) Uncomment if using obs as weights, weight_SE=sum(df_se$weight_SE))
##################
# produce 95% CI of averages
df_models <- merge.data.frame(df_coeff, df_se, by = "treatment_id")
average_ci_u <- df_coeff[t+1,2:p] + 1.96*df_se[t+1,2:p]
average_ci_l <- df_coeff[t+1,2:p] - 1.96*df_se[t+1,2:p]
rbind.data.frame(average_ci_l, df_coeff[t+1,2:p], average_ci_u)
write.csv(df_models, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertainty_MODEL_DG.csv", row.names = F)
log_file = "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertain_stata_AIC_NU.log"
df_aic <- read_log(file=log_file,
skip=10,
n_max = t)
df_aic
colnames(df_aic) <- c("treatment_id", "Full")
avg_aic <- df_aic %>%
summarise(across(Selfish_aic:FU_aic, ~mean(., na.rm=T)))
avg_aic <- df_aic %>%
summarise(across(Full, ~mean(., na.rm=T)))
avg_aic
df_aic <- df_aic %>%
add_row(treatment_id="Average", avg_aic)
write.csv(df_aic, "~/GitHub/Social_norm_meta_analysis/Analysis/Utility estimation/Output/Logs/uncertainty_AIC_DG.csv", row.names = F)
df_aic
