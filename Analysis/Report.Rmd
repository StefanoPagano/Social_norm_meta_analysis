---
title: "Social Norms Meta"
output: 
  html_document:
    toc: True
    toc_float: True
---

# Analysis Treatment-level: All Games

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment="", include=FALSE}

library(ggplot2)
library(tidyverse)
library(mclogit)
library(sjmisc)
library(ggrepel)
library(readxl)
library(ggpubr)

setwd("../")

# read data 
master <- read.csv("File_DB/Output/Treatment.csv") %>% mutate(Delta_Avg = Avg_NE - Avg_coop,
                                                              Macro_game_type = ifelse(Game_type %in% c("DG","Donation Game"), "DG and Donation Game", Game_type))
DG <- master %>% subset.data.frame(Game_type=="DG" & Choice_Method== "Direct")
DG_UG <- master %>% subset.data.frame(Game_type=="DG"|Game_type=="UG")
UG <- master %>% subset.data.frame(Game_type=="UG")

```

<br>

## HP1: Relation between norms and actions

<br>

<h4><i>Are norms and cooperation behavior related?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Avg_NE, master$Avg_coop, method= "spearman", exact = F)

ggplot(data=master, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("H1 : Correlation Between Average Cooperation and Norm (NE)") + stat_cor(method = "spearman")

ggplot(data=master, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("H1 : Correlation Between Average Cooperation and Norm (NE)") + facet_wrap(~Macro_game_type, ncol=3) + stat_cor(method = "spearman")

```

## HP2: Norm Uncertainty

<br>

- a. Does a higher norm variability lead to lower cooperation?
- b. Does a higher norm variability lead to higher cooperation variance?

<br>

<h4><i>a. Does a higher norm variability lead to lower cooperation?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Var_NE, master$Avg_coop, method= "spearman", exact = F)
ggplot(data=master, aes(x=Var_NE, y=Avg_coop)) + geom_point() + geom_smooth() + ggtitle("H2a : Correlation Between Average Cooperation and Norm Variance (NE)")

ggplot(data=master, aes(x=Var_NE, y=Avg_coop)) + geom_point() + ggtitle("H2a : Correlation Between Average Cooperation and Norm Variance (NE)") + facet_wrap(~Game_type, ncol=3)

```

<br>

<h4><i>b. Does a higher norm variability lead to higher cooperation var.?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Var_NE, master$Var_coop, method= "spearman", exact = F)
ggplot(data=master, aes(x=Var_NE, y=Var_coop, color=Game_type)) + geom_point() + geom_smooth() + ggtitle("H2b : Correlation Between Variance Cooperation and Norm (NE)")

```

<br>

## HP3 : Norm Strength

<br>

<h4><i>Does higher norm strength lead to higher norm compliance?</i></h4>

<br>

<b>How did we compute Norm Strength Index?</b>

<br>

$$Strength = {NE_{avg} \over NE_{sd}}$$
<b>where:</b>

- $NE_{sd}$ is the standard deviation of means of KW appropriateness score (for each scenarios)

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
Strenght_stat_df <- master %>% subset.data.frame(subset = Strength_N<5)
```

<b>Summary of Norm strength</b>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
summary(Strenght_stat_df$Strength_N)
```

<br>

<b>Distribution</b>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
hist(Strenght_stat_df$Strength_N, breaks = 6, main = "Histogram of Norm Strength", xlab = "Strength Norm", border = "#edf6f9", col = "#001d3d")
```

<br>

<b>Results</b>
- $Delta_{avg} = NE_{avg} - Coop_{avg}$

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
new_master = master %>% mutate(new_strenght = Avg_NE/(sqrt(Var_NE)+Sd_Avg_NE)) %>% subset
cor.test(Strenght_stat_df$Strength_N, Strenght_stat_df$Delta_Avg, method= "spearman", exact = F)
ggplot(data=Strenght_stat_df, aes(x=Strength_N, y=Delta_Avg)) + geom_point() + geom_smooth(method = "lm")# + geom_text(aes(label=PaperID))

```

<br>

## New Strength

<br>

$$Strength = {1 \over NE_{Specificity}+NE_{Consistency}}$$
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
new_master = master %>% mutate(new_strenght = 1/(sqrt(Var_NE)+Sd_Avg_NE)) %>% mutate(Delta_new = (Avg_NE-Avg_coop)/Avg_NE)
cor.test(new_master$new_strenght, new_master$Delta_new, method= "spearman", exact = F)
ggplot(data=new_master, aes(x=new_strenght, y=Delta_new, color=Game_type)) + geom_point() + geom_smooth(method = "lm")+ facet_wrap(~Game_type, ncol=3)# + geom_text(aes(label=PaperID))
ggplot(data=new_master, aes(x=new_strenght, y=Delta_new)) + geom_point() + geom_smooth(method = "lm")

```
<h6><b>Note:</b> without outliers</h6>

<center><h2>Analysis Treatment-level: Dictator Game</center></h2>

<br>

<h3>HP1: Relation between norms and actions</h3>

<br>

<h4><i>Are stronger norms related with higher cooperation?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(DG$Avg_NE, DG$Avg_coop, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("H1 : Correlation Between Average Cooperation and Norm (NE)\nDG Only")
```

## HP2: Norm Uncertainty

<br>

- a. Does a higher norm variability lead to lower cooperation?
- b. Does a higher norm variability lead to higher cooperation variance?

<br>

<h4><i>a. Does a higher norm variability lead to lower cooperation?</i></h4>
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(DG$Var_NE, DG$Avg_coop, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Var_NE, y=Avg_coop)) + geom_point() + geom_smooth() + ggtitle("H2a : Correlation Between Average Cooperation and Norm Variance (NE)\nDG Only")
```

<h4><i>b. Does a higher norm variability lead to higher cooperation variance?</i></h4>
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(DG$Var_NE, DG$Var_coop, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Var_NE, y=Var_coop, color=Game_type)) + geom_point() + geom_smooth() + ggtitle("H2b : Correlation Between Variance Cooperation and Norm (NE)\nDG Only")
```

## HP3 : Norm Strength

<br>

<h4><i>Does higher norm strength lead to higher norm compliance?</i></h4>

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(DG$Strength_N, DG$Delta_Avg, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Strength_N, y=Delta_Avg)) + geom_point() + geom_smooth(method = "lm")
```

# INDIVIDUAL-LEVEL ANALYSIS
setwd("C:/Users/stefa/Documenti/CNR/GitHub/Social_norm_meta_analysis/")
beliefs <- read.csv("File_DB/Output/Subjects_beliefs.csv", sep = ",")
choices <- read.csv("File_DB/Output/Subjects_choices.csv", sep = ",")


## Within-subjects Design

## issues: 
### - 345 subjects but only 342 in preliminary analysis: check if subjects are the same and scenarios are all for everyone

beliefs_w <- beliefs %>% subset.data.frame(subset = Design=="Within")
choices_w <- choices %>% subset.data.frame(subset = Design=="Within")
individual_db_w <- merge.data.frame(choices_w, beliefs_w)

# prelim analysis all together
model_1 <- mclogit(cbind(A,scenarios)~KW_Normative,data=individual_db_w)

model_2017Del037 <- mclogit(cbind(A,scenarios)~KW_Normative,data=individual_db_w %>% 
                            subset.data.frame(subset = paper_id =="2017Del037"))

model_2020Bas115 <- mclogit(cbind(A,scenarios)~KW_Normative,data=individual_db_w %>% 
                              subset.data.frame(subset = paper_id=="2020Bas115"))

tab_model(model_1, model_2017Del037, 
          model_2020Bas115, 
          dv.labels = c("general model","Del037_model_1","2020Bas115"))

plot_models(model_1, model_2017Del037, 
          model_2020Bas115)
