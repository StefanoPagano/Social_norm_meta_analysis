---
title: "Social Norms Meta"
output: 
  html_document:
    toc: True
    toc_float: True
---

# Analysis Treatment-level: All Games

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment="", include=FALSE}
rm(list=ls())
library(ggplot2)
library(tidyverse)
library(mclogit)
library(sjmisc)
library(ggrepel)
library(readxl)
library(ggpubr)
library(survival)
library(sjPlot)

setwd("../")

# read data 
master <- read.csv("File_DB/Output/Treatment.csv") %>% mutate(Delta_Avg = Avg_NE - Avg_coop,
                                                            Macro_game_type = ifelse(Game_type %in% c("DG","Donation Game"), "DG and Donation Game", Game_type)) %>% subset.data.frame(subset = PaperID !="2017Del037")

```

<br>

## HP1: Relation between norms and actions

<br>

<h4><i>Are norms and cooperation behavior related?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Avg_NE, master$Avg_coop, method= "spearman", exact = F)

ggplot(data=master, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 1: H1 : Correlation Between Average Cooperation and Norm (NE)") + stat_cor(method = "spearman")

ggplot(data=master, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 2: H1 : Correlation Between Average Cooperation and Norm (NE)") + facet_wrap(~Macro_game_type, ncol=3) + stat_cor(method = "spearman")

```

### Results
- Evidence from testing H1 shows that there is a positive and significant correlation between social expectations and cooperative behavior (Fig. 1).
- By splitting data by game type, there is evidence of positive and significant correlation in DG (and Donation game), while norms are not heterogeneous in other game types. 
- Hence, the analysis including all games possibly makes more sense here.

## HP2: Norm Uncertainty

<br>

- a. Does a higher norm variability lead to lower cooperation?
- b. Does a higher norm variability lead to higher cooperation variance?

<br>

to do so we computed VAR NE SUCA as ...

<h4><i>a. Does a higher norm variability lead to lower cooperation?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Var_NE, master$Avg_coop, method= "spearman", exact = F)

ggplot(data=master, aes(x=Var_NE, y=Avg_coop)) + geom_point() + geom_smooth(method="lm") + ggtitle("Fig. 3 H2a : Correlation Between Average Cooperation and Norm Variance (NE)") + stat_cor(method = "spearman") 

ggplot(data=master, aes(x=Var_NE, y=Avg_coop)) + geom_point() + ggtitle("Fig. 4 H2a : Correlation Between Average Cooperation and Norm Variance (NE)") + facet_wrap(~Macro_game_type, ncol=3) + stat_cor(method = "spearman") + geom_smooth(method="lm")

```
<br>

<h4><i>b. Does a higher norm variability lead to higher cooperation var.?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Var_NE, master$Var_coop, method= "spearman", exact = F)
ggplot(data=master, aes(x=Var_NE, y=Var_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 5 H2b : Correlation Between Variance Cooperation and Norm (NE)")

ggplot(data=master, aes(x=Var_NE, y=Var_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 6 H2b : Correlation Between Variance Cooperation and Norm (NE)") + facet_wrap(~Macro_game_type) + stat_cor(method = "spearman")

```

<br>

## HP3 : Is compliance related to norm strength?

$$Strength = {1 \over NE_{Specificity}+NE_{Consistency}}$$
where SUCA

specificity is Var NE and consistency is SUCA
We compute compliance as delta SUCA


```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

master = master %>% mutate(Norm_Strength = 1/(sqrt(Var_NE)+Sd_Avg_NE)) %>% mutate(Delta_new = (Avg_NE-Avg_coop))

cor.test(master$Norm_Strength, master$Delta_new, method= "spearman", exact = F)

ggplot(data=master, aes(x=Norm_Strength, y=Delta_new)) + geom_point() + geom_smooth(method = "lm") + stat_cor(method = "spearman")

ggplot(data=master, aes(x=Norm_Strength, y=Delta_new)) + geom_point() + geom_smooth(method = "lm")+ facet_wrap(~Macro_game_type, ncol=3) + stat_cor(method = "spearman")# + geom_text(aes(label=PaperID))

```

<b>Summary of Norm strength</b>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
summary(master$Norm_Strength)
```

<b>Distribution</b>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
ggplot(data=master, aes(x=Norm_Strength)) +
geom_histogram() + ggtitle("Histogram of Norm Strength") + xlab("Strength Norm") + facet_wrap(~Macro_game_type)

```

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
DG <- master %>% subset.data.frame(Game_type=="DG" & Choice_Method== "Direct")
DG_UG <- master %>% subset.data.frame(Game_type=="DG"|Game_type=="UG")
UG <- master %>% subset.data.frame(Game_type=="UG")
```

# Analysis Treatment-level: Dictator Game

<br>

## HP1: Relation between norms and actions

<br>

<h4><i>Are stronger norms related with higher cooperation?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(DG$Avg_NE, DG$Avg_coop, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("H1 : Correlation Between Average Cooperation and Norm (NE)\nDG Only")
```

## HP2: Norm Uncertainty

<br>

- a. Does a higher norm variability lead to lower cooperation?
- b. Does a higher norm variability lead to higher cooperation variance?

<br>

<h4><i>a. Does a higher norm variability lead to lower cooperation?</i></h4>
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(DG$Var_NE, DG$Avg_coop, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Var_NE, y=Avg_coop)) + geom_point() + geom_smooth() + ggtitle("H2a : Correlation Between Average Cooperation and Norm Variance (NE)\nDG Only")
```

<h4><i>b. Does a higher norm variability lead to higher cooperation variance?</i></h4>
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(DG$Var_NE, DG$Var_coop, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Var_NE, y=Var_coop, color=Game_type)) + geom_point() + geom_smooth() + ggtitle("H2b : Correlation Between Variance Cooperation and Norm (NE)\nDG Only")
```

## HP3 : Norm Strength

<br>

<h4><i>Does higher norm strength lead to higher norm compliance?</i></h4>

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(DG$Norm_Strength, DG$Delta_Avg, method= "spearman", exact = F)
ggplot(data=DG, aes(x=Norm_Strength, y=Delta_Avg)) + geom_point() + geom_smooth(method = "lm")
```

# Individual-level analysis

## Analysis plan
Here we estimate a random utility model.
We split our individual-level analysis into 2 steps: 

1. we estimate the utility function when beliefs and actions are elicited for the same subject
2. we estimate the utility function when beliefs and actions are elicited using distinct subjects


For 1., the model we estimate is the following:

$U_ij = \alpha \pi_j + \beta S_ij$ 

while for 2., we use $S_j=\Sigma S_ij/N$ from the external sample with which social norms were elicited.

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
beliefs <- read.csv("../File_DB/Output/Subjects_beliefs.csv", sep = ",")
choices <- read.csv("../File_DB/Output/Subjects_choices.csv", sep = ",")
```

## Within-subjects Design
```{r}
beliefs_w <- beliefs %>% subset.data.frame(subset = Design=="Within")
choices_w <- choices %>% subset.data.frame(subset = Design=="Within")
individual_db_w <- merge.data.frame(choices_w, beliefs_w)
```


### 2020Bas115
```{r}
Bas115 = individual_db_w %>% subset.data.frame(paper_id=="2020Bas115") %>% mutate(payoff=endowment-scenarios)
clogit.bas <- clogit(A~ payoff + KW_Normative + strata(subject_id), data = Bas115)
```

#### issues: 
- 345 subjects but only 342 in preliminary analysis: check if subjects are the same and scenarios are all for everyone

## Between 
```{r}
beliefs_b <- beliefs %>% subset.data.frame(subset = Design=="Between") %>% group_by(paper_id, scenarios) %>% summarise(KW_Normative = mean(KW_Normative))
choices_b <- choices %>% subset.data.frame(subset = Design=="Between")%>% mutate(payoff=endowment-scenarios)
individual_db_b <- merge.data.frame(choices_b, beliefs_b)

```

```{r}
between <- clogit(A~ payoff + KW_Normative + strata(subject_id, treatment_id, paper_id), data = individual_db_b)
betas=between$coefficients
sigma=sqrt(between$var) # diagonal is variance; others are covariance
plot_model(model = between )
```

