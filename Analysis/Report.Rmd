---
title: "Social Norms Meta"
output: 
  html_document:
    toc: True
    toc_float: True
---

# Analysis Treatment-level: All Games

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment="", include=FALSE}
rm(list=ls())
library(ggplot2)
library(tidyverse)
library(mclogit)
library(sjmisc)
library(ggrepel)
library(readxl)
library(ggpubr)
library(survival)
library(sjPlot)
library(kableExtra)
library(car)

setwd("../")

# read data 
master <- read.csv("File_DB/Output/Treatment.csv") %>% 
  mutate(Macro_game_type = ifelse(Game_type %in% c("DG","Donation Game"), "DG and Donation Game", Game_type)) %>% 
  subset.data.frame(subset = !(Standard_game %in% c("N")))

```

<br>

## HP1: Relation between norms and actions

<br>

<h4><i>Are norms and cooperation behavior related?</i></h4>

The content of the norm and behavior correlate positively.

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Avg_NE, master$Avg_coop, method= "spearman", exact = F)

ggplot(data=master, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 1: H1 : Correlation Between Average Cooperation and Norm (NE)") + stat_cor(method = "spearman") + xlab("Cooperation Norm (as % of endowment)") + ylab("Cooperation (% of endowment)")

ggplot(data=master, aes(x=Avg_NE, y=Avg_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 2: H1 : Correlation Between Average Cooperation and Norm (NE)") + facet_wrap(~Macro_game_type, ncol=3) + stat_cor(method = "spearman")

```

### Results
- Evidence from testing H1 shows that there is a positive and significant correlation between social expectations and cooperative behavior (Fig. 1).
- By splitting data by game type, there is evidence of positive and significant correlation in DG (and Donation game), while norms are not heterogeneous in other game types. 
- Hence, the analysis including all games possibly makes more sense here.


<br>

## HP3 : Is compliance related to norm strength?

We compute norm strength as:

$$Strength = {NE_{Consistency}+NE_{Specificity}}$$

where:

* $NE_{Specificity} = {1 \over \sigma_{j}}$ is the reciprocal of the standard deviation computed on Krupka-Weber average appropriateness scores across all actions $j$

* $NE_{Consistency} = {1 \over \sigma_{N}}$ is the reciprocal of the standard deviation computed on the most appropriate action $N$.

We compute compliance as $Delta = NE_{avg}-Coop_{avg}$

<b>Summary of Norm strength</b>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
# specificity = Sd_Avg_NE
# consistency = sqrt(Var_NE)

master = master %>% mutate(Norm_Strength = 1/sqrt(Var_NE) + 1/Sd_Avg_NE,
                           Delta = (Avg_NE-Avg_coop))
```


```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
summary(master$Norm_Strength)
```

<b>Distribution</b>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
ggplot(data=master, aes(x=Norm_Strength)) +
geom_histogram() + ggtitle("Histogram of Norm Strength") + xlab("Strength Norm") + facet_wrap(~Macro_game_type)

```

  
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
cor.test(master$Norm_Strength, master$Delta, method= "spearman", exact = F)

ggplot(data=master, aes(x=Norm_Strength, y=Delta)) + geom_point() + geom_smooth(method = "lm") + stat_cor(method = "spearman")

ggplot(data=master, aes(x=Norm_Strength, y=Delta)) + geom_point() + geom_smooth(method = "lm")+ facet_wrap(~Macro_game_type, ncol=3) + stat_cor(method = "spearman")# + geom_text(aes(label=PaperID))

```


```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
DG <- master %>% subset.data.frame(Game_type=="DG" & Choice_Method== "Direct")
DG_UG <- master %>% subset.data.frame(Game_type=="DG"|Game_type=="UG")
UG <- master %>% subset.data.frame(Game_type=="UG")
```

## HP4: Effect of punishment on norms and actions

### Cooperation, Delta and Strength Comparison between DG and UG

We test the hypothesis whether :

* **Cooperation** ($Coop_{avg}$) in DG and Donation Game is lower then UG.

  + The p-value of Mann-Whitney-Wilcoxon Test is *0.0088*, therefore we *can* reject the null hypothesis (at .05 significance level).

* **Normative Expectation** ($NE_{avg}$) in DG and Donation Game is lower then UG.

  + The p-value of Mann-Whitney-Wilcoxon Test is *0.4923*, therefore we *can't* reject the null hypothesis (at .05 significance level).
  
* **Delta** in DG and Donation Game is lower then UG.
  + *Delta* is computed as $NE_{avg}-Coop_{avg}$ 
  + The p-value of Mann-Whitney-Wilcoxon Test is *0.0242*, therefore we *can* reject the null hypothesis (at .05 significance level).
  
* **Norm Strength** in DG and Donation Game is lower then UG.

  + The p-value of Mann-Whitney-Wilcoxon Test is *0.1989*, therefore we *can't* reject the null hypothesis (at .05 significance level).
  


```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
hp4_mean <- master %>% 
  subset.data.frame(subset = Macro_game_type %in% c("DG and Donation Game", "UG")) %>%
  group_by(Macro_game_type) %>% 
  summarise(Coop = mean(Avg_coop, na.rm = T), 
            Avg_Norm = mean(Avg_NE, na.rm = T), 
            Delta = mean(Delta, na.rm = T), 
            Strength = mean(Norm_Strength, na.rm = T),
            n = n()) %>% 
  arrange(Macro_game_type)

master_test <- master %>% subset.data.frame(select = c(Game_type, Avg_coop, Avg_NE, Delta, Norm_Strength, Macro_game_type, Sd_Avg_NE, Var_NE), subset = Game_type %in% c("DG", "UG"))

wilc_delta = wilcox.test(Delta ~ Macro_game_type, data=master_test)
wilc_strength = wilcox.test(Norm_Strength ~ Macro_game_type, data = master_test)
wilc_coop = wilcox.test(Avg_coop ~ Macro_game_type, data = master_test)
wilc_norm = wilcox.test(Avg_NE ~ Macro_game_type, data = master_test)

hp4plus_mean <- hp4_mean %>% add_row(Macro_game_type = "Difference (Wilcoxon p-value)", Coop = wilc_coop$p.value, Avg_Norm = wilc_norm$p.value, Delta = wilc_delta$p.value, Strength = wilc_strength$p.value)

opts <- options(knitr.kable.NA = "")
kbl(hp4plus_mean, digits = 4, booktabs = T, align = "lccccc", centering = F, caption = "Average and Mann-Whitney-Wilcoxon Test") %>%
  kable_styling(position = "left", full_width = F) %>%
  column_spec(1, bold = T) %>%
  row_spec(3, bold = T, color = "white", background = "#6c757d")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
# hp4_sd <- master %>% 
#   subset.data.frame(subset = Macro_game_type %in% c("DG and Donation Game", "UG")) %>%
#   group_by(Macro_game_type) %>% 
#   summarise(Coop = sd(Avg_coop, na.rm = T), 
#             Avg_Norm = sd(Avg_NE, na.rm = T), 
#             Delta = sd(Delta, na.rm = T), 
#             Strength = sd(Norm_Strength, na.rm = T),
#             n = n()) %>% 
#   arrange(Macro_game_type)
# 
# opts <- options(knitr.kable.NA = "")
# kbl(hp4_sd, digits = 4, booktabs = T, align = "lccccc", centering = F, caption = "Standard Deviation") %>%
#   kable_styling(position = "left", full_width = F) %>%
#   column_spec(1, bold = T)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
hp4_SP_CS <- master %>% 
  subset.data.frame(subset = Macro_game_type %in% c("DG and Donation Game", "UG")) %>%
  group_by(Macro_game_type) %>% 
  summarise(Specificity = mean(1/(Sd_Avg_NE), na.rm = T), 
            Consistency = mean(1/(sqrt(Var_NE)), na.rm = T)) %>% 
  arrange(Macro_game_type)

F_test_spec <- wilcox.test(1/(master_test$Sd_Avg_NE) ~ master_test$Macro_game_type)
F_test_cons <- wilcox.test(1/(sqrt(master_test$Var_NE)) ~ master_test$Macro_game_type)

hp4plus_SP_CS <- hp4_SP_CS %>% 
  add_row(Macro_game_type = "Difference (Wilcoxon p-value)", Specificity = F_test_spec$p.value, Consistency = F_test_cons$p.value)

opts <- options(knitr.kable.NA = "")
kbl(hp4plus_SP_CS, digits = 4, booktabs = T, align = "lcc", centering = F, caption = "Consistency e Specificity") %>%
  kable_styling(position = "left", full_width = F) %>%
  column_spec(1, bold = T) %>%
  row_spec(3, bold = T, color = "white", background = "#6c757d")

ggarrange(ggplot(master_test) + geom_density(aes(color = Macro_game_type, x=log(1/Sd_Avg_NE))) + xlab("Specificity"),
ggplot(master_test) + geom_density(aes(color = Macro_game_type, x=log(1/sqrt(Var_NE)))) + xlab("Consistency"), common.legend = T)

```

ciao questo Ã¨ il risultato `r F_test_spec$p.value`


# Individual-level analysis

## Analysis plan
Here we estimate a random utility model.
We split our individual-level analysis into 2 steps: 

1. *Within subject design belief elicitation papers*: we estimate the utility function when beliefs and actions are elicited for the same subject
2. *Between subject design belief elicitation papers*: we estimate the utility function when beliefs and actions are elicited using distinct subjects


For 1., the model we estimate is the following:
<center>
$U_{ij} = \alpha \pi_j + \beta S_{ij}$ 
</center>

while for 2., we use $S_j=\Sigma S_{ij}/N$ from the external sample with which social norms were elicited. Hence the model becomes:
<center>
$U_{ij} = \alpha \pi_j + \beta S_{j}$ 
</center>


```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
beliefs <- read.csv("../File_DB/Output/Subjects_beliefs.csv", sep = ",")
choices <- read.csv("../File_DB/Output/Subjects_choices.csv", sep = ",")
dataframe_betas <- data.frame(ID=NA, alpha=NA, beta=NA,var_alpha=NA,var_beta=NA)
```

## Within-subjects Design
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
beliefs_w <- beliefs %>% subset.data.frame(subset = Design=="Within")
choices_w <- choices %>% subset.data.frame(subset = Design=="Within")
individual_db_w <- merge.data.frame(choices_w, beliefs_w)
```


### 2020Bas115
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
Bas115 = individual_db_w %>% subset.data.frame(paper_id=="2020Bas115") %>% mutate(payoff=endowment-scenarios)
clogit.bas <- clogit(A~ payoff + KW_Normative + strata(subject_id), data = Bas115)
summary(clogit.bas)
dataframe_betas[1,] <- c("2020Bas115",clogit.bas$coefficients["payoff"],clogit.bas$coefficients["KW_Normative"],clogit.bas$var[1,1],clogit.bas$var[2,2])
```

## Between 
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
beliefs_b <- beliefs %>% subset.data.frame(subset = Design=="Between") %>% group_by(paper_id, scenarios) %>% summarise(KW_Normative = mean(KW_Normative))
choices_b <- choices %>% subset.data.frame(subset = Design=="Between")%>% mutate(payoff=endowment-scenarios)
individual_db_b <- merge.data.frame(choices_b, beliefs_b)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
between <-clogit(A~ payoff + KW_Normative, data = individual_db_b)
betas=between$coefficients
summary(between)
dataframe_betas[2,] <- c("Avg. Between",between$coefficients["payoff"],between$coefficients["KW_Normative"],between$var[1,1],between$var[2,2])
```

### 2016Kim003
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
Kim003 = individual_db_b %>% subset.data.frame(paper_id=="2016Kim003") %>% mutate(payoff=endowment-scenarios) %>% subset.data.frame(subset = subject_id!="2016Kim003_7_2222")
Kim003 <- dfidx(Kim003 %>% mutate(scenarios=as.factor(scenarios)),
            idx = c("subject_id","scenarios"), 
            idpkg = "mlogit")
head(Kim003)
mlogit.kim <- mlogit(A~payoff+KW_Normative|0, data = Kim003)
summary(mlogit.kim)$CoefTable[1,2] ### SUCA
dataframe_etas[3,] <- c("2016Kim003",mlogit.kim$coefficients["payoff"],mlogit.kim$coefficients["KW_Normative"],mlogit.kim$[1,1],between$var[2,2])
```

### 2018Her061
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
Her061 = individual_db_b %>% subset.data.frame(paper_id=="2018Her061") %>% mutate(payoff=endowment-scenarios)
Her061 <- dfidx(Her061 %>% mutate(scenarios=as.factor(scenarios)),
            idx = c("subject_id","scenarios"), 
            idpkg = "mlogit")
mlogit.her <- mlogit(A~ 0+payoff + KW_Normative, data = Her061)
summary(mlogit.her)

```

### 2019Cha026
``` {r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}
Cha026 = individual_db_b %>% subset.data.frame(paper_id=="2019Cha026") %>% mutate(payoff=endowment-scenarios)
clogit.cha <- clogit(A~ payoff + KW_Normative + strata(subject_id, treatment_id, paper_id), data = Cha026)
summary(clogit.cha)
betas=clogit.cha$coefficients
sigma=sqrt(clogit.cha$var) # diagonal is variance; others are covariance
plot_model(model = clogit.cha, title = "2019Cha026: Conditional Logit Model")
```


# Appendix : Effect of varibility on norms and actions

## HP2: Norm Uncertainty

<br>

- a. Does a higher norm variability lead to lower cooperation?
- b. Does a higher norm variability lead to higher cooperation variance?

<br>

to do so we computed VAR NE as ...

<h4><i>a. Does a higher norm variability lead to lower cooperation?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Var_NE, master$Avg_coop, method= "spearman", exact = F)

ggplot(data=master, aes(x=Var_NE, y=Avg_coop)) + geom_point() + geom_smooth(method="lm") + ggtitle("Fig. 3 H2a : Correlation Between Average Cooperation and Norm Variance (NE)") + stat_cor(method = "spearman") 

ggplot(data=master, aes(x=Var_NE, y=Avg_coop)) + geom_point() + ggtitle("Fig. 4 H2a : Correlation Between Average Cooperation and Norm Variance (NE)") + facet_wrap(~Macro_game_type, ncol=3) + stat_cor(method = "spearman") + geom_smooth(method="lm")

```
<br>

<h4><i>b. Does a higher norm variability lead to higher cooperation var.?</i></h4>

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, comment=""}

cor.test(master$Var_NE, master$Var_coop, method= "spearman", exact = F)
ggplot(data=master, aes(x=Var_NE, y=Var_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 5 H2b : Correlation Between Variance Cooperation and Norm (NE)")

ggplot(data=master, aes(x=Var_NE, y=Var_coop)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Fig. 6 H2b : Correlation Between Variance Cooperation and Norm (NE)") + facet_wrap(~Macro_game_type) + stat_cor(method = "spearman")

```


``` {r}
list_of_paper <- master %>% mutate(data_type = ifelse(is.na(Avg_NE), "Actions", ifelse(is.na(Avg_coop), "Norms", "Both"))) %>% 
  group_by(data_type, PaperID, Game_type, Method_elicitation, Separate_sample_beliefs, Standard_game) %>% 
  summarise(n_treatments = n())
            
opts <- options(knitr.kable.NA = "")
kbl(list_of_paper, digits = 4, booktabs = T, align = "lcccccc", centering = F, caption = "Ciao") %>%
  kable_styling(position = "left", full_width = F) %>%
  column_spec(1, bold = T)

```

